<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Computer Use Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .welcome {
            text-align: center;
            padding: 3rem 2rem;
            color: #9ca3af;
        }

        .welcome h2 {
            color: #e0e0e0;
            margin-bottom: 1rem;
        }

        .examples {
            margin-top: 2rem;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .examples ul {
            margin-top: 0.5rem;
            list-style-position: inside;
            color: #60a5fa;
        }

        .examples li {
            margin: 0.5rem 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 8px;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #1e3a5f;
            border: 1px solid #2563eb;
            align-self: flex-end;
            max-width: 80%;
        }

        .message.agent {
            background: #1f1f1f;
            border: 1px solid #555555;
            align-self: flex-start;
            max-width: 80%;
        }

        .message.error {
            background: #3a1a1a;
            border: 1px solid #ef4444;
            align-self: flex-start;
            max-width: 80%;
        }

        .message-label {
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.8;
        }

        .message-content {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .loading {
            display: inline-flex;
            gap: 4px;
            margin-right: 8px;
        }

        .loading span {
            width: 6px;
            height: 6px;
            background: #888888;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .input-form {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: #1a1a1a;
            border-top: 1px solid #333;
        }

        .input-field {
            flex: 1;
            padding: 0.875rem 1.25rem;
            background: #0a0a0a;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .input-field:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-button {
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .debug-panel {
            background: #0a0a0a;
            border-top: 1px solid #333;
            transition: max-height 0.3s ease;
            max-height: 40px;
            overflow: hidden;
        }

        .debug-panel.expanded {
            max-height: 300px;
        }

        .debug-header {
            padding: 0.75rem 1.5rem;
            background: #1a1a1a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.2s;
        }

        .debug-header:hover {
            background: #252525;
        }

        .debug-header .toggle {
            color: #60a5fa;
            font-size: 0.9rem;
        }

        .debug-content {
            height: 260px;
            overflow-y: auto;
            padding: 1rem;
        }

        .debug-content::-webkit-scrollbar {
            width: 8px;
        }

        .debug-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .debug-content::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        .debug-empty {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            font-style: italic;
        }

        .debug-logs {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #d1d5db;
        }

        .log-line {
            padding: 0.2rem 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .log-line:hover {
            background: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Computer Use Agent</h1>
        <p>AI-powered automation assistant</p>
    </div>

    <div class="main-container">
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome">
                    <h2>Welcome!</h2>
                    <p>Enter a task below to get started.</p>
                    <div class="examples">
                        <p>Example tasks:</p>
                        <ul>
                            <li>Create a new patient record</li>
                            <li>Fill out the registration form</li>
                            <li>Navigate to the dashboard</li>
                        </ul>
                    </div>
                </div>
            </div>

            <form class="input-form" id="inputForm">
                <input
                    type="text"
                    id="inputField"
                    class="input-field"
                    placeholder="Enter a task for the agent..."
                    autocomplete="off"
                />
                <button type="submit" class="send-button" id="sendButton">‚ñ∂</button>
            </form>
        </div>

        <div class="debug-panel" id="debugPanel">
            <div class="debug-header" id="debugHeader">
                <span id="debugTitle">üîç Debug Logs</span>
                <span class="toggle">‚ñ≤</span>
            </div>
            <div class="debug-content">
                <div class="debug-empty" id="debugEmpty">No logs yet. Start a task to see debug output.</div>
                <div class="debug-logs" id="debugLogs" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Use relative URL since HTML is served from Flask
        const API_URL = '';
        let isRunning = false;
        let eventSource = null;

        const messagesEl = document.getElementById('messages');
        const inputField = document.getElementById('inputField');
        const inputForm = document.getElementById('inputForm');
        const sendButton = document.getElementById('sendButton');
        const debugPanel = document.getElementById('debugPanel');
        const debugHeader = document.getElementById('debugHeader');
        const debugTitle = document.getElementById('debugTitle');
        const debugEmpty = document.getElementById('debugEmpty');
        const debugLogs = document.getElementById('debugLogs');

        let logCount = 0;
        let taskStartTime = null;

        function addMessage(type, content) {
            const welcome = messagesEl.querySelector('.welcome');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = type === 'user' ? 'üë§ You' :
                               type === 'error' ? '‚ùå Error' : 'ü§ñ Agent';

            const content_div = document.createElement('div');
            content_div.className = 'message-content';

            if (type === 'agent' && content === 'loading') {
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.innerHTML = '<span></span><span></span><span></span>';
                content_div.appendChild(loading);
                content_div.appendChild(document.createTextNode('Working on it...'));
            } else {
                content_div.textContent = content;
            }

            messageDiv.appendChild(label);
            messageDiv.appendChild(content_div);
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            return messageDiv;
        }

        function addLog(text) {
            logCount++;
            debugTitle.textContent = `üîç Debug Logs (${logCount})`;
            debugEmpty.style.display = 'none';
            debugLogs.style.display = 'block';

            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            logLine.textContent = text;
            debugLogs.appendChild(logLine);
            debugLogs.parentElement.scrollTop = debugLogs.parentElement.scrollHeight;
        }

        function clearLogs() {
            logCount = 0;
            debugTitle.textContent = 'üîç Debug Logs';
            debugLogs.innerHTML = '';
            debugLogs.style.display = 'none';
            debugEmpty.style.display = 'block';
        }

        debugHeader.addEventListener('click', () => {
            debugPanel.classList.toggle('expanded');
            const toggle = debugHeader.querySelector('.toggle');
            toggle.textContent = debugPanel.classList.contains('expanded') ? '‚ñº' : '‚ñ≤';
        });

        inputForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!inputField.value.trim() || isRunning) return;

            const task = inputField.value.trim();
            inputField.value = '';
            clearLogs();

            addMessage('user', task);
            const loadingMsg = addMessage('agent', 'loading');

            // Record start time
            taskStartTime = Date.now();

            isRunning = true;
            inputField.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = '‚è≥';

            try {
                console.log('Sending task to backend:', task);

                // Start task
                const response = await fetch(`${API_URL}/api/task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to start task: ${response.status} - ${errorText}`);
                }

                // Connect to log stream
                eventSource = new EventSource(`${API_URL}/api/logs`);

                eventSource.onmessage = (event) => {
                    const data = event.data;

                    if (data === '[DONE]') {
                        eventSource.close();
                        loadingMsg.remove();

                        // Calculate elapsed time
                        const elapsedMs = Date.now() - taskStartTime;
                        const elapsedSec = (elapsedMs / 1000).toFixed(2);
                        const minutes = Math.floor(elapsedMs / 60000);
                        const seconds = ((elapsedMs % 60000) / 1000).toFixed(2);

                        const timeStr = minutes > 0
                            ? `${minutes}m ${seconds}s`
                            : `${elapsedSec}s`;

                        addMessage('agent', `‚úÖ Task completed in ${timeStr}\n\nCheck debug logs for details.`);
                        isRunning = false;
                        inputField.disabled = false;
                        sendButton.disabled = false;
                        sendButton.textContent = '‚ñ∂';
                        return;
                    }

                    addLog(data);
                };

                eventSource.onerror = () => {
                    eventSource.close();
                    loadingMsg.remove();
                    addMessage('error', 'Connection error. Check if backend is running on port 5000.');
                    isRunning = false;
                    inputField.disabled = false;
                    sendButton.disabled = false;
                    sendButton.textContent = '‚ñ∂';
                };

            } catch (error) {
                console.error('Caught error:', error);
                loadingMsg.remove();
                addMessage('error', `Error: ${error.message}\n\nCheck browser console (F12) for details.\nMake sure Flask backend is running on port 5000.`);
                isRunning = false;
                inputField.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = '‚ñ∂';
            }
        });

        // Test backend connection on load
        fetch(`${API_URL}/api/health`)
            .then(r => r.json())
            .then(() => console.log('‚úÖ Connected to backend'))
            .catch(() => console.error('‚ùå Backend not reachable. Start Flask server: python backend/app.py'));
    </script>
</body>
</html>
